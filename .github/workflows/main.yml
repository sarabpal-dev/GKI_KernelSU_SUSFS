name: Build Kernels

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: "Choose Release Type"
        required: true
        type: choice
        options:
          - Actions
          - Pre-Release
          - Release
        default: Actions
      build_selection:
        description: "Choose which kernels to build"
        required: true
        type: choice
        options:
          - All
          - Android12-5.10
          - Android13-5.10
          - Android13-5.15
          - Android14-5.15
          - Android14-6.1
          - Android15-6.6
        default: All
      susfs_version:
        description: "Choose SUSFS version to build"
        required: true
        type: choice
        options:
          - v1.5.12
          - v1.5.9
        default: v1.5.12

jobs:

  build-a12-5-10:
    if: inputs.build_selection == 'All' || inputs.build_selection == 'Android12-5.10'
    uses: ./.github/workflows/kernel-a12-5-10.yml
    secrets: inherit
    with:
      ksu_variant: "WKSU"

  build-a13-5-10:
    if: inputs.build_selection == 'All' || inputs.build_selection == 'Android13-5.10'
    uses: ./.github/workflows/kernel-a13-5-10.yml
    secrets: inherit
    with:
      ksu_variant: "WKSU"

  build-a13-5-15:
    if: inputs.build_selection == 'All' || inputs.build_selection == 'Android13-5.15'
    uses: ./.github/workflows/kernel-a13-5-15.yml
    secrets: inherit
    with:
      ksu_variant: "WKSU"

  build-a14-5-15:
    if: inputs.build_selection == 'All' || inputs.build_selection == 'Android14-5.15'
    uses: ./.github/workflows/kernel-a14-5-15.yml
    secrets: inherit
    with:
      ksu_variant: "WKSU"

  build-a14-6-1:
    if: inputs.build_selection == 'All' || inputs.build_selection == 'Android14-6.1'
    uses: ./.github/workflows/kernel-a14-6-1.yml
    secrets: inherit
    with:
      ksu_variant: "WKSU"

  build-a15-6-6:
    if: inputs.build_selection == 'All' || inputs.build_selection == 'Android15-6.6'
    uses: ./.github/workflows/kernel-a15-6-6.yml
    secrets: inherit
    with:
      ksu_variant: "WKSU"

  release:
    runs-on: ubuntu-latest
    if: (success() || failure()) && inputs.release_type != 'Actions'
    needs:
      - build-a12-5-10
      - build-a13-5-10
      - build-a13-5-15
      - build-a14-5-15
      - build-a14-6-1
      - build-a15-6-6

    env:
      RELEASE_NAME: "GKI Kernels With WKSU & SUSFS v1.5.12"
      
    steps:
      - name: Free Disk Space
        run: |
          echo "===== Initial Total Disk Space in GB ====="
          df -h
          curl -Ls https://raw.githubusercontent.com/apache/arrow/main/ci/scripts/util_free_space.sh | bash
          echo "===== Total Disk Space After Cleanup in GB ====="
          df -h
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Get commit hashes and generate commit URLs
        run: |
          GITLAB_OWNER="simonpunk"
          GITLAB_REPO="susfs4ksu"
          
          declare -A BRANCH_MAP=(
            ["gki_android12_5_10"]="gki-android12-5.10"
            ["gki_android13_5_10"]="gki-android13-5.10"
            ["gki_android13_5_15"]="gki-android13-5.15"
            ["gki_android14_5_15"]="gki-android14-5.15"
            ["gki_android14_6_1"]="gki-android14-6.1"
            ["gki_android15_6_6"]="gki-android15-6.6"
          )
          
          for var_name in "${!BRANCH_MAP[@]}"; do
            branch_name="${BRANCH_MAP[$var_name]}"
            COMMIT_HASH=$(git ls-remote https://gitlab.com/$GITLAB_OWNER/$GITLAB_REPO.git refs/heads/$branch_name | awk '{ print $1 }')
            
            if [[ -n "$COMMIT_HASH" ]]; then
              COMMIT_URL="https://gitlab.com/$GITLAB_OWNER/$GITLAB_REPO/-/commit/$COMMIT_HASH"
              echo "$branch_name Commit: $COMMIT_HASH"
              echo "$branch_name Commit URL: $COMMIT_URL"
              
              echo "COMMIT_HASH_${var_name}=$COMMIT_HASH" >> "$GITHUB_ENV"
              echo "COMMIT_URL_${var_name}=$COMMIT_URL" >> "$GITHUB_ENV"
            fi
          done

      - name: Get KernelSU variant refs and links
        run: |
          # Get WKSU latest commit from wild branch
          WKSU_REF=$(git ls-remote "https://github.com/WildKernels/Wild_KSU.git" refs/heads/wild | awk '{print $1}')
          WKSU_URL="https://github.com/WildKernels/Wild_KSU/commit/$WKSU_REF"
          echo "WKSU_REF=$WKSU_REF" >> $GITHUB_ENV
          echo "WKSU_URL=$WKSU_URL" >> $GITHUB_ENV
          
          # Get Baseband-guard latest commit from main branch
          BBG_REF=$(git ls-remote "https://github.com/vc-teahouse/Baseband-guard.git" refs/heads/main | awk '{print $1}')
          BBG_URL="https://github.com/vc-teahouse/Baseband-guard/commit/$BBG_REF"
          echo "BBG_REF=$BBG_REF" >> $GITHUB_ENV
          echo "BBG_URL=$BBG_URL" >> $GITHUB_ENV

      - name: Generate New Tag
        run: |
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [ -z "$LATEST_TAG" ]; then
              LATEST_TAG="v1.5.12-r0"
            fi
            
            NEW_TAG=$(echo "$LATEST_TAG" | awk -F'-r' '{suffix=$2; if (!suffix) suffix=0; suffix++; printf "%s-r%d", $1, suffix}')
    
            echo "New tag: $NEW_TAG"
            echo "NEW_TAG=${NEW_TAG}" >> $GITHUB_ENV

      - name: Download All Artifacts
        uses: actions/download-artifact@v5
        with:
          path: ./downloaded-artifacts

      - name: Organize Release Files
        run: |
          mkdir -p ./release-files
          
          # Process all artifacts
          for artifact_dir in ./downloaded-artifacts/*/; do
            artifact_name=$(basename "$artifact_dir")
            echo "Processing artifact: $artifact_name"
            
            # --- Handle vmlinux artifacts ---
            if [[ "$artifact_name" == *"-vmlinux" ]]; then
              # Zip name is the artifact name with .zip extension
              zip_name="${artifact_name}.zip"
              vmlinux_path="$artifact_dir/vmlinux"
              
              if [ -f "$vmlinux_path" ]; then
                # Create a zip archive containing the vmlinux file
                zip -j "./release-files/${zip_name}" "$vmlinux_path"
                echo "Created vmlinux archive: ${zip_name}"
              fi
              continue # Move to next artifact
            fi

            # --- Handle boot image artifacts ---
            
            # Determine the base name for the zip file by removing the variant
            zip_basename=$(echo "$artifact_name" | sed -E 's/-(Normal|vTomsonek)$//')
            if [[ -z "$zip_basename" ]]; then
                echo "Could not determine zip_basename for artifact: $artifact_name. Skipping."
                continue
            fi
            zip_name="${zip_basename}.zip"

            # Determine android_ver from artifact name for internal file naming
            android_ver=""
            if [[ "$artifact_name" == *"-android12-"* ]]; then android_ver="android12"
            elif [[ "$artifact_name" == *"-android13-"* ]]; then android_ver="android13"
            elif [[ "$artifact_name" == *"-android14-"* ]]; then android_ver="android14"
            elif [[ "$artifact_name" == *"-android15-"* ]]; then android_ver="android15"
            fi
            
            if [[ -z "$android_ver" ]]; then
                echo "Could not determine android_ver for artifact: $artifact_name. Skipping."
                continue
            fi

            # Prepare a temporary directory for files to be zipped
            temp_zip_dir="./temp-for-zip"
            mkdir -p "$temp_zip_dir"
            
            year_month=$(date +%Y-%m)
            found_images=false

            # Find original boot images, rename them, and copy to temp dir
            for boot_img_path in "$artifact_dir"/*.img; do
              if [ -f "$boot_img_path" ]; then
                found_images=true
                boot_img_name=$(basename "$boot_img_path")
                
                img_suffix=""
                if [[ "$boot_img_name" == *"-boot.img" ]]; then img_suffix="boot.img"
                elif [[ "$boot_img_name" == *"-boot-gz.img" ]]; then img_suffix="boot-gz.img"
                elif [[ "$boot_img_name" == *"-boot-lz4.img" ]]; then img_suffix="boot-lz4.img"
                fi

                if [[ -n "$img_suffix" ]]; then
                  new_internal_name="${android_ver}-${year_month}-${img_suffix}"
                  cp "$boot_img_path" "${temp_zip_dir}/${new_internal_name}"
                  echo "  - Staging for zip: ${new_internal_name}"
                fi
              fi
            done

            # If images were found, create the zip archive
            if [ "$found_images" = true ]; then
              (cd "$temp_zip_dir" && zip "../release-files/${zip_name}" ./*)
              echo "Created boot image archive: ${zip_name}"
            fi

            # Clean up temp directory
            rm -rf "$temp_zip_dir"
          done
          
          echo "Release files prepared:"
          ls -lh ./release-files/

      - name: Set release body
        run: |
          cat << 'EOF' > release_body.md
      
          **IMPORTANT DISCLAIMER**
          This software is provided for testing and educational purposes only. Use at your own risk.
          The developers are not responsible for any damage, data loss, or issues that may occur.
          Please ensure you have proper backups before installation.

          Features:
          -> Wild KSU
          -> Multi Manager Support for WKSU, KernelSU-Next! Needs Testing: KSU, MKSU RKSU, xxKSU, KowSU and SukiSU (Best compatibility with WKSU, no support will be provided for other managers)
          -> SUSFS à¶ž v1.5.12
          -> Scope-Minimized Manual hooks v1.4
          -> Ptrace Patch Support for Older Kernels (<5.16)
          -> IPSet Support for Advanced Network Filtering
          -> Wireguard Support
          -> BBR v1 Support
          -> Added BBG support to prevent unauthorised writes to certain partitions: https://github.com/vc-teahouse/Baseband-guard

          Notes:
          -> SUS SU Mode 2 will show as disabled or not compatble due to non-kprobe hooks and is not needed anymore!
          -> Official Kernel Flasher is broken with latest susfs, try https://github.com/fatalcoder524/KernelFlasher/
          -> **Files ending with .zip**: Available for fastboot flashing
          -> **Files ending with -vmlinux.zip**: Debug symbols for kernel debugging and crash analysis
          -> **Warning**: kernel files may not boot on some Android 16 devices
      
          Module: 
          -> https://github.com/sidex15/ksu_module_susfs
      
          Managers:
          -> WKSU: https://github.com/WildKernels/Wild_KSU
          -> Next: https://github.com/KernelSU-Next/KernelSU-Next
          
          Commit Hashes (at the time of release):
          -> WKSU: [${{ env.WKSU_REF }}](${{ env.WKSU_URL }})

          -> Baseband-guard: [${{ env.BBG_REF }}](${{ env.BBG_URL }})

          -> SUSFS4KSU: 
            -> gki-android12-5.10: [${{ env.COMMIT_HASH_gki_android12_5_10 }}](${{ env.COMMIT_URL_gki_android12_5_10 }})
            -> gki-android13-5.10: [${{ env.COMMIT_HASH_gki_android13_5_10 }}](${{ env.COMMIT_URL_gki_android13_5_10 }})
            -> gki-android13-5.15: [${{ env.COMMIT_HASH_gki_android13_5_15 }}](${{ env.COMMIT_URL_gki_android13_5_15 }})
            -> gki-android14-5.15: [${{ env.COMMIT_HASH_gki_android14_5_15 }}](${{ env.COMMIT_URL_gki_android14_5_15 }})
            -> gki-android14-6.1: [${{ env.COMMIT_HASH_gki_android14_6_1 }}](${{ env.COMMIT_URL_gki_android14_6_1 }})
            -> gki-android15-6.6: [${{ env.COMMIT_HASH_gki_android15_6_6 }}](${{ env.COMMIT_URL_gki_android15_6_6 }})
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.NEW_TAG }}
          prerelease: ${{ inputs.release_type == 'Pre-Release' }}
          files: ./release-files/*
          name: ${{ env.RELEASE_NAME }}
          body_path: release_body.md
          token: ${{ secrets.RELEASE }}

      - name: Display Files Uploaded
        run: |
          echo "GitHub release created with the following files:"
          ls -lh ./release-files/
